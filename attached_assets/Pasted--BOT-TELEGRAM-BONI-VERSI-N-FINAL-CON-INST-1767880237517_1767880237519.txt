// ==================================================
// BOT TELEGRAM BONI ‚Äì VERSI√ìN FINAL CON INSTITUTO
// ==================================================

const TELEGRAM_TOKEN = "8557005763:AAFs3AvvarCmiDYHxBAkQZuKcOUOBOmDVis";
const SPREADSHEET_ID = "1_AtufxeQhg2IrMRWpHdhrafKEOYepsXa07mDDPm2lac";
const DRIVE_FOLDER_ID = "1agh6iVBv-8eFSHrChnc8G-63nGkI0pWW"; // Sobres de espiga
const DRIVE_FOLDER_MATRICULA = "1eJ_4TW436rr5QwDq-YP8kliZ3H43URqr"; // Matr√≠culas
const DRIVE_FOLDER_MENSUALIDAD = "1yJCC4hdkZV9CQXr_Nb1pHKLr-E0CMb8F"; // Pagos mensuales
const EMAIL_REPORTE_GENERAL = "cris.ahu777@gmail.com"; 

// ==================================================
// TELEGRAM
// ==================================================
function sendMessage(chatId, text, keyboard = null, inlineKeyboard = null) {
  const payload = { 
    chat_id: chatId, 
    text
  };
  if (keyboard) payload.reply_markup = keyboard;
  if (inlineKeyboard) payload.reply_markup = inlineKeyboard;

  UrlFetchApp.fetch(
    `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`,
    {
      method: "post",
      contentType: "application/json",
      payload: JSON.stringify(payload)
    }
  );
}

// ==================================================
// MEMORIA
// ==================================================
function getState(chatId) {
  const d = PropertiesService.getUserProperties().getProperty(chatId);
  return d ? JSON.parse(d) : {};
}
function setState(chatId, s) {
  PropertiesService.getUserProperties().setProperty(chatId, JSON.stringify(s));
}
function clearState(chatId) {
  PropertiesService.getUserProperties().deleteProperty(chatId);
}

// ==================================================
// DATA
// ==================================================
function getSheets() {
  return SpreadsheetApp.openById(SPREADSHEET_ID).getSheets();
}

function getMinisteriosSheets() {
  return getSheets().filter(s => 
    s.getName() !== "PETICIONES" && 
    s.getName() !== "NUEVOS DE ESPIGAS" && 
    s.getName() !== "INSTITUTO DE A√ëO" &&
    s.getName() !== "INSTITUTO MATERIA VIRTUAL"
  );
}

// ==================================================
// VERIFICAR SI ES L√çDER AUTORIZADO
// ==================================================
function esLiderAutorizado(nombreLider, sheetName) {
  const sheet = getSheets().find(s => s.getName() === sheetName);
  if (!sheet) return false;
  
  const lastRow = sheet.getLastRow();
  if (lastRow < 2) return false;
  
  const lideres = sheet.getRange(`H2:H${lastRow}`).getValues().flat().filter(String);
  
  return lideres.some(lider => 
    lider.toLowerCase().trim() === nombreLider.toLowerCase().trim()
  );
}

// ==================================================
// VALIDACIONES
// ==================================================
function esNumero(texto) {
  return /^\d+$/.test(texto.trim());
}

function tieneLetras(texto) {
  return /[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë]/.test(texto);
}

function soloNumeros(texto) {
  return /^\d+(\.\d+)?$/.test(texto.trim());
}

// ==================================================
// TECLADOS
// ==================================================
function mainKeyboard() {
  const botones = [];
  
  // Consultar l√≠deres oculto por el momento
  // botones.push([{ text: "Consultar l√≠deres" }]);
  
  // Instituto siempre visible
  botones.push([{ text: "üìö Inscripci√≥n al Instituto B√≠blico Horeb" }]);
  
  botones.push([{ text: "Cargar sobre de espiga" }]);
  botones.push([{ text: "üôè Enviar petici√≥n de oraci√≥n" }]);
  botones.push([{ text: "Terminar" }]);
  
  return {
    keyboard: botones,
    resize_keyboard: true
  };
}

function ministeriosKeyboard() {
  const rows = getMinisteriosSheets().map(s => [{ text: s.getName() }]);
  rows.push([{ text: "Terminar" }]);
  return { keyboard: rows, resize_keyboard: true };
}

function institutoOpcionesKeyboard() {
  return {
    keyboard: [
      [{ text: "Curso materias virtuales" }],
      [{ text: "Curso el a√±o" }],
      [{ text: "Carga del comprobante de pago del mes" }],
      [{ text: "Terminar" }]
    ],
    resize_keyboard: true
  };
}

function institutoA√±osKeyboard() {
  return {
    keyboard: [
      [{ text: "1ero (Lunes 19:20hs a 23:50hs)" }],
      [{ text: "2do (Viernes 19:20hs a 23:50hs)" }],
      [{ text: "3ero (Sabado 14:00hs a 18:30hs)" }],
      [{ text: "4to (Lunes 19:20hs a 23:50hs)" }],
      [{ text: "5to Plan nuevo (Lunes 19:20hs a 23:50hs)" }],
      [{ text: "7mo Plan Anterior (Materias alternativas en dias)" }],
      [{ text: "Terminar" }]
    ],
    resize_keyboard: true
  };
}

function institutoMateriasKeyboard() {
  return {
    keyboard: [
      [{ text: "Materia virtual 1" }],
      [{ text: "Materia virtual 2" }],
      [{ text: "Materia virtual 3" }],
      [{ text: "Materia virtual 4" }],
      [{ text: "Materia virtual 5" }],
      [{ text: "Materia virtual 6" }],
      [{ text: "Terminar" }]
    ],
    resize_keyboard: true
  };
}

function siNoKeyboard() {
  return {
    keyboard: [
      [{ text: "SI" }],
      [{ text: "NO" }],
      [{ text: "Terminar" }]
    ],
    resize_keyboard: true
  };
}

function confirmKeyboard() {
  return {
    keyboard: [
      [{ text: "‚úÖ Confirmar y guardar" }],
      [{ text: "‚ùå Cancelar" }]
    ],
    resize_keyboard: true
  };
}

function confirmarInstitutoKeyboard() {
  return {
    keyboard: [
      [{ text: "‚úÖ Confirmar y guardar datos" }],
      [{ text: "‚ùå Cancelar y volver a cargar los datos" }]
    ],
    resize_keyboard: true
  };
}

function peticionConWhatsAppKeyboard() {
  return {
    keyboard: [
      [{ text: "Terminar" }]
    ],
    resize_keyboard: true
  };
}

// ==================================================
// FOTO - SOPORTA M√öLTIPLES CARPETAS
// ==================================================
function savePhoto(fileId, folderId = DRIVE_FOLDER_ID) {
  const info = JSON.parse(
    UrlFetchApp.fetch(
      `https://api.telegram.org/bot${TELEGRAM_TOKEN}/getFile?file_id=${fileId}`
    ).getContentText()
  );

  const blob = UrlFetchApp.fetch(
    `https://api.telegram.org/file/bot${TELEGRAM_TOKEN}/${info.result.file_path}`
  ).getBlob();

  const f = DriveApp.getFolderById(folderId).createFile(blob);
  f.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
  return f.getUrl();
}

// ==================================================
// PERSONA NUEVA Y PETICIONES
// ==================================================
function detectarPersonaNueva(texto) {
  const textoLower = texto.toLowerCase();
  return textoLower.includes("nuevo") || textoLower.includes("nueva");
}

function registrarPersonaNueva(textoAsistentes, userName) {
  const sheet = getSheets().find(s => s.getName() === "NUEVOS DE ESPIGAS");
  if (!sheet) return;
  
  const fechaHora = Utilities.formatDate(new Date(), "GMT-3", "dd/MM/yyyy HH:mm:ss");
  sheet.appendRow([textoAsistentes, fechaHora, userName]);
  
  const lastRow = sheet.getLastRow();
  const emails = sheet.getRange(`D2:D${lastRow}`).getValues().flat().filter(String);
  
  if (emails.length === 0) return;
  
  const cuerpoMail = `Se detect√≥ una persona nueva en una espiga.

Datos de asistencia:
${textoAsistentes}

Usuario que registr√≥:
${userName}

Fecha y hora:
${fechaHora}`;

  emails.forEach(mail => MailApp.sendEmail(mail, "Se detect√≥ una persona nueva en una espiga", cuerpoMail));
}

function esMotivoDeOracion(texto) {
  const textoLower = texto.toLowerCase().trim();
  const palabrasExcluidas = ["ninguna", "ninguno", "nada"];
  return !palabrasExcluidas.some(p => textoLower.includes(p));
}

function enviarPeticionOracion(motivo, userName) {
  const sheet = getSheets().find(s => s.getName() === "PETICIONES");
  if (!sheet) return;
  const fechaHora = new Date();
  sheet.appendRow([motivo, fechaHora, userName]);

  const emailDestino = sheet.getRange("D2").getValue();
  if (emailDestino) {
    MailApp.sendEmail(emailDestino, "Nueva petici√≥n de oraci√≥n (desde carga de espiga)",
      `Motivo: ${motivo}\nUsuario: ${userName}\nFecha: ${fechaHora}`);
  }
}

// ==================================================
// BUSCAR ALUMNO EN INSTITUTO
// ==================================================
function buscarAlumnoInstituto(nombre) {
  const sheets = getSheets();
  const hojas = ["INSTITUTO DE A√ëO", "INSTITUTO MATERIA VIRTUAL"];

  for (const hojaName of hojas) {
    const sheet = sheets.find(s => s.getName() === hojaName);
    if (!sheet) continue;

    const lastRow = sheet.getLastRow();
    if (lastRow < 2) continue;

    const nombres = sheet.getRange(`A2:A${lastRow}`).getValues().flat();
    for (let i = 0; i < nombres.length; i++) {
      if (nombres[i].toString().toLowerCase().trim() === nombre.toLowerCase().trim()) {
        return { encontrado: true, hoja: hojaName };
      }
    }
  }
  return { encontrado: false };
}

// ==================================================
// WEBHOOK
// ==================================================
function doPost(e) {
  const update = JSON.parse(e.postData.contents);
  if (!update.message) return;

  const chatId = update.message.chat.id;
  const userName = update.message.from.first_name +
    (update.message.from.last_name ? " " + update.message.from.last_name : "");
  const text = update.message.text;
  const state = getState(chatId);

  // CANCELAR
  if (text === "Terminar" || text === "‚ùå Cancelar" || text === "‚ùå Cancelar y volver a cargar los datos") {
    clearState(chatId);
    sendMessage(chatId, "Proceso cancelado. Gracias por comunicarte con BONI üôå", mainKeyboard());
    return;
  }

  // ACCESO CON C√ìDIGO - No se usa ya que Instituto es siempre visible
  if (text === "Esteban2025" && !state.step) {
    sendMessage(chatId, "Hola Soy BONI ü§ç\n¬øEn qu√© te puedo ayudar hoy?", mainKeyboard());
    return;
  }

  // BOTONES PRINCIPALES
  if (text === "Consultar l√≠deres") {
    // Oculto por el momento - no hacer nada o mostrar mensaje
    sendMessage(chatId, "Esta funci√≥n est√° temporalmente oculta.", mainKeyboard());
    return;
  }

  if (text === "Cargar sobre de espiga") {
    setState(chatId, { step: "cargar_ministerio" });
    sendMessage(chatId, "¬øEn qu√© ministerio est√°s liderando?", ministeriosKeyboard());
    return;
  }

  if (text === "üôè Enviar petici√≥n de oraci√≥n") {
    setState(chatId, { step: "peticion" });
    const sheet = getSheets().find(s => s.getName() === "PETICIONES");
    const whatsappLink = sheet?.getRange("G2").getValue() || "";
    
    const mensaje = "üôè ¬øCu√°l es el motivo de tu petici√≥n de oraci√≥n?\n\nSi prefer√≠s hablar directamente con alguien:";
    
    if (whatsappLink) {
      const inlineKeyboard = { inline_keyboard: [[{ text: "üí¨ Abrir WhatsApp", url: whatsappLink }]] };
      sendMessage(chatId, mensaje, null, inlineKeyboard);
      Utilities.sleep(500);
      sendMessage(chatId, "Pod√©s escribir tu petici√≥n o usar el bot√≥n üëÜ", peticionConWhatsAppKeyboard());
    } else {
      sendMessage(chatId, "üôè ¬øCu√°l es el motivo de tu petici√≥n de oraci√≥n?", peticionConWhatsAppKeyboard());
    }
    return;
  }

  if (text === "üìö Inscripci√≥n al Instituto B√≠blico Horeb") {
    setState(chatId, { step: "instituto_menu" });
    sendMessage(chatId, "Seleccion√° una opci√≥n:", institutoOpcionesKeyboard());
    return;
  }

  // SIN ESTADO ‚Üí MEN√ö PRINCIPAL
  if (!state.step) {
    sendMessage(chatId, "Hola Soy BONI ü§ç\n¬øEn qu√© te puedo ayudar hoy?", mainKeyboard());
    return;
  }

  const sheets = getSheets();

  // PETICI√ìN DE ORACI√ìN
  if (state.step === "peticion") {
    const sheet = sheets.find(s => s.getName() === "PETICIONES");
    const fechaHora = new Date();
    sheet.appendRow([text, fechaHora, userName]);

    const emailDestino = sheet.getRange("D2").getValue();
    if (emailDestino) {
      MailApp.sendEmail(emailDestino, "Nueva petici√≥n de oraci√≥n",
        `Motivo: ${text}\nUsuario: ${userName}\nFecha: ${fechaHora}`);
    }

    clearState(chatId);
    sendMessage(chatId, "üôè Gracias por compartir tu petici√≥n.\nVamos a estar orando por vos ü§ç", mainKeyboard());
    return;
  }

  // CONSULTAR L√çDERES - Oculto
  if (state.step === "consultar") {
    sendMessage(chatId, "Esta funci√≥n est√° temporalmente oculta.", mainKeyboard());
    clearState(chatId);
    return;
  }

  // CARGA DE ESPIGA
  if (state.step === "cargar_ministerio") {
    state.sheetName = text;
    state.step = "mentor";
    setState(chatId, state);
    sendMessage(chatId, "¬øQui√©n es tu mentor?");
    return;
  }

  if (state.step === "mentor") {
    state.mentor = text;
    state.step = "lider";
    setState(chatId, state);
    sendMessage(chatId, "¬øQui√©n es el l√≠der que carga el sobre?");
    return;
  }

  if (state.step === "lider") {
    if (!esLiderAutorizado(text, state.sheetName)) {
      state.intentosLider = (state.intentosLider || 0) + 1;
      if (state.intentosLider >= 2) {
        clearState(chatId);
        sendMessage(chatId, "‚ùå No ten√©s autorizaci√≥n para cargar sobres en este ministerio.", mainKeyboard());
        return;
      }
      setState(chatId, state);
      sendMessage(chatId, "‚ùå No est√°s habilitado como l√≠der.\nPor favor, pon√© tu nombre completo:");
      return;
    }
    state.lider = text;
    state.step = "asistentes";
    delete state.intentosLider;
    setState(chatId, state);
    sendMessage(chatId, "¬øCu√°ntas personas asistieron a la espiga y si hubo una persona nueva? (Ej: 8 personas - Nueva: Juan P√©rez)");
    return;
  }

  if (state.step === "asistentes") {
    if (!tieneLetras(text)) {
      sendMessage(chatId, "‚ö†Ô∏è Por favor, inclu√≠ al menos una letra.\nEjemplo: 8 personas - Nueva: Mar√≠a");
      return;
    }
    state.asistentes = text;
    state.step = "motivo";
    setState(chatId, state);
    sendMessage(chatId, "¬øFalt√≥ alguien a la espiga y tienen alg√∫n motivo de oraci√≥n?");
    return;
  }

  if (state.step === "motivo") {
    if (esNumero(text)) {
      sendMessage(chatId, "‚ö†Ô∏è No pod√©s enviar solo n√∫meros. Ejemplo: 2 ausencias - Mar√≠a est√° enferma");
      return;
    }
    state.motivo = text;
    state.tieneMotivoOracion = esMotivoDeOracion(text);
    state.step = "ofrenda";
    setState(chatId, state);
    sendMessage(chatId, "¬øCu√°nto fue el monto de ofrenda? (solo n√∫meros, ej: 5000)");
    return;
  }

  if (state.step === "ofrenda") {
    if (!soloNumeros(text)) {
      sendMessage(chatId, "‚ö†Ô∏è Por favor, ingres√° solo n√∫meros.\nEjemplo: 5000");
      return;
    }
    state.ofrenda = text;
    state.step = "foto";
    setState(chatId, state);
    sendMessage(chatId, "Sub√≠ la foto del sobre de espiga.");
    return;
  }

  if (update.message.photo && state.step === "foto") {
    state.foto = savePhoto(update.message.photo.pop().file_id);
    state.step = "confirmar";
    setState(chatId, state);

    sendMessage(chatId,
      `üìå Confirm√° los datos:\n\nMinisterio: ${state.sheetName}\nMentor: ${state.mentor}\nL√≠der: ${state.lider}\nAsistentes: ${state.asistentes}\nAusencias/Motivo: ${state.motivo}\nOfrenda: ${state.ofrenda}`,
      confirmKeyboard()
    );
    return;
  }

  if (state.step === "confirmar" && text === "‚úÖ Confirmar y guardar") {
    const sheet = sheets.find(s => s.getName() === state.sheetName);
    const fechaHora = Utilities.formatDate(new Date(), "GMT-3", "dd/MM/yyyy HH:mm:ss");
    const lastRow = sheet.getLastRow() + 1;

    sheet.getRange(lastRow, 1).setValue(state.mentor);
    sheet.getRange(lastRow, 2).setValue(state.lider);
    sheet.getRange(lastRow, 3).setValue(state.foto);
    sheet.getRange(lastRow, 4).setValue(state.motivo);
    sheet.getRange(lastRow, 5).setValue(fechaHora);
    sheet.getRange(lastRow, 6).setValue(userName);
    sheet.getRange(lastRow, 7).setValue("");
    sheet.getRange(lastRow, 13).setValue(state.asistentes);
    sheet.getRange(lastRow, 14).setValue(state.ofrenda);

    if (detectarPersonaNueva(state.asistentes)) registrarPersonaNueva(state.asistentes, userName);
    if (state.tieneMotivoOracion) enviarPeticionOracion(state.motivo, userName);

    clearState(chatId);
    sendMessage(chatId, "‚úÖ Sobre de espiga cargada con √©xito.\nGracias por tu fidelidad üôè", mainKeyboard());
    return;
  }

  // ================== INSTITUTO B√çBLICO HOREB ==================

  if (state.step === "instituto_menu") {
    if (text === "Curso el a√±o") {
      state.step = "instituto_a√±o_nombre";
      state.tipo = "a√±o";
      setState(chatId, state);
      sendMessage(chatId, "Apellido y nombre completo del alumno a inscribirse:");
      return;
    }
    if (text === "Curso materias virtuales") {
      state.step = "instituto_virtual_nombre";
      state.tipo = "virtual";
      setState(chatId, state);
      sendMessage(chatId, "Apellido y nombre completo del alumno a inscribirse:");
      return;
    }
    if (text === "Carga del comprobante de pago del mes") {
      state.step = "instituto_pago_nombre";
      state.intentos = 0;
      setState(chatId, state);
      sendMessage(chatId, "Apellido y nombre completo (exactamente como te inscribiste):");
      return;
    }
  }

  // CURSO ANUAL
  if (state.step === "instituto_a√±o_nombre") {
    if (!tieneLetras(text)) {
      sendMessage(chatId, "‚ö†Ô∏è Ingres√° un nombre v√°lido con letras:");
      return;
    }
    state.nombreCompleto = text;
    state.step = "instituto_a√±o_curso";
    setState(chatId, state);
    sendMessage(chatId, "¬øA qu√© a√±o dese√°s inscribirte?", institutoA√±osKeyboard());
    return;
  }

  if (state.step === "instituto_a√±o_curso") {
    const validos = ["3 a√±o los lunes", "4 a√±o los lunes", "5 a√±o los lunes", "3 a√±o los viernes", "4 a√±o los viernes", "5 a√±o los viernes", "3 a√±o los Sabados", "4 a√±o los Sabados", "5 a√±o los Sabados"];
    if (!validos.includes(text)) {
      sendMessage(chatId, "‚ö†Ô∏è Seleccion√° una opci√≥n v√°lida:", institutoA√±osKeyboard());
      return;
    }
    state.curso = text;
    state.step = "instituto_a√±o_foto_matricula";
    setState(chatId, state);
    sendMessage(chatId, "Carg√° la foto del comprobante de pago de matr√≠cula:");
    return;
  }

  if (update.message.photo && state.step === "instituto_a√±o_foto_matricula") {
    state.fotoMatricula = savePhoto(update.message.photo.pop().file_id, DRIVE_FOLDER_MATRICULA);
    state.step = "instituto_a√±o_foto_mes";
    setState(chatId, state);
    sendMessage(chatId, "Carg√° la foto del comprobante del pago del mes:");
    return;
  }

  if (update.message.photo && state.step === "instituto_a√±o_foto_mes") {
    state.fotoMes = savePhoto(update.message.photo.pop().file_id, DRIVE_FOLDER_MENSUALIDAD);
    state.step = "instituto_a√±o_confirmar";
    setState(chatId, state);
    sendMessage(chatId, `üìå Confirm√° los datos:\n\nNombre: ${state.nombreCompleto}\nCurso: ${state.curso}\nMatr√≠cula: ‚úÖ\nMensualidad: ‚úÖ`, confirmarInstitutoKeyboard());
    return;
  }

  if (state.step === "instituto_a√±o_confirmar" && text === "‚úÖ Confirmar y guardar datos") {
    const sheet = sheets.find(s => s.getName() === "INSTITUTO DE A√ëO");
    const fechaHora = Utilities.formatDate(new Date(), "GMT-3", "dd/MM/yyyy HH:mm:ss");
    sheet.appendRow([state.nombreCompleto, state.curso, state.fotoMatricula, state.fotoMes, fechaHora, userName]);
    clearState(chatId);
    sendMessage(chatId, "‚úÖ Te inscribiste correctamente al Instituto Horeb 2026", mainKeyboard());
    return;
  }

  // MATERIAS VIRTUALES
  if (state.step === "instituto_virtual_nombre") {
    if (!tieneLetras(text)) {
      sendMessage(chatId, "‚ö†Ô∏è Ingres√° un nombre v√°lido:");
      return;
    }
    state.nombreCompleto = text;
    state.step = "instituto_virtual_materia";
    setState(chatId, state);
    sendMessage(chatId, "Seleccion√° la materia virtual:", institutoMateriasKeyboard());
    return;
  }

  if (state.step === "instituto_virtual_materia") {
    const validas = ["Materia virtual 1","Materia virtual 2","Materia virtual 3","Materia virtual 4","Materia virtual 5","Materia virtual 6"];
    if (!validas.includes(text)) {
      sendMessage(chatId, "‚ö†Ô∏è Seleccion√° una materia v√°lida:", institutoMateriasKeyboard());
      return;
    }
    state.materia = text;
    state.step = "instituto_virtual_matricula_pregunta";
    setState(chatId, state);
    sendMessage(chatId, "¬øPagaste la matr√≠cula anual del a√±o que est√°s cursando?", siNoKeyboard());
    return;
  }

  if (state.step === "instituto_virtual_matricula_pregunta") {
    if (text === "SI") {
      state.pagoMatricula = "SI";
      state.step = "instituto_virtual_foto_mes";
      setState(chatId, state);
      sendMessage(chatId, "Carg√° el comprobante de pago de la materia:");
      return;
    }
    if (text === "NO") {
      state.pagoMatricula = "NO";
      state.step = "instituto_virtual_foto_matricula";
      setState(chatId, state);
      sendMessage(chatId, "Carg√° el comprobante de matr√≠cula anual:");
      return;
    }
    sendMessage(chatId, "‚ö†Ô∏è Respond√© SI o NO:", siNoKeyboard());
    return;
  }

  if (update.message.photo && state.step === "instituto_virtual_foto_matricula") {
    state.fotoMatricula = savePhoto(update.message.photo.pop().file_id, DRIVE_FOLDER_MATRICULA);
    state.step = "instituto_virtual_foto_mes";
    setState(chatId, state);
    sendMessage(chatId, "Carg√° el comprobante de pago de la materia:");
    return;
  }

  if (update.message.photo && state.step === "instituto_virtual_foto_mes") {
    state.fotoMes = savePhoto(update.message.photo.pop().file_id, DRIVE_FOLDER_MENSUALIDAD);
    state.step = "instituto_virtual_confirmar";
    setState(chatId, state);
    let msg = `üìå Confirm√° los datos:\n\nNombre: ${state.nombreCompleto}\nMateria: ${state.materia}\nPag√≥ matr√≠cula: ${state.pagoMatricula}`;
    if (state.fotoMatricula) msg += "\nMatr√≠cula: ‚úÖ";
    msg += "\nMensualidad: ‚úÖ";
    sendMessage(chatId, msg, confirmarInstitutoKeyboard());
    return;
  }

  if (state.step === "instituto_virtual_confirmar" && text === "‚úÖ Confirmar y guardar datos") {
    const sheet = sheets.find(s => s.getName() === "INSTITUTO MATERIA VIRTUAL");
    const fechaHora = Utilities.formatDate(new Date(), "GMT-3", "dd/MM/yyyy HH:mm:ss");
    sheet.appendRow([state.nombreCompleto, state.materia, state.pagoMatricula, state.fotoMatricula || "", state.fotoMes, fechaHora, userName]);
    clearState(chatId);
    sendMessage(chatId, "‚úÖ Inscripci√≥n a materia virtual exitosa", mainKeyboard());
    return;
  }

  // CARGA DE PAGO MENSUAL
  if (state.step === "instituto_pago_nombre") {
    const resultado = buscarAlumnoInstituto(text);
    if (!resultado.encontrado) {
      state.intentos = (state.intentos || 0) + 1;
      if (state.intentos >= 2) {
        clearState(chatId);
        sendMessage(chatId, "‚ùå Nombre no encontrado. Verific√° que sea exactamente igual al de tu inscripci√≥n.", mainKeyboard());
        return;
      }
      setState(chatId, state);
      sendMessage(chatId, "‚ùå Nombre incorrecto. Intent√° de nuevo:");
      return;
    }
    state.nombreCompleto = text;
    state.hojaEncontrada = resultado.hoja;
    state.step = "instituto_pago_foto";
    setState(chatId, state);
    sendMessage(chatId, "Carg√° el comprobante de pago de este mes:");
    return;
  }

  if (update.message.photo && state.step === "instituto_pago_foto") {
    state.fotoMes = savePhoto(update.message.photo.pop().file_id, DRIVE_FOLDER_MENSUALIDAD);
    state.step = "instituto_pago_confirmar";
    setState(chatId, state);
    sendMessage(chatId, `üìå Confirm√°:\n\nNombre: ${state.nombreCompleto}\nComprobante: ‚úÖ`, confirmarInstitutoKeyboard());
    return;
  }

  if (state.step === "instituto_pago_confirmar" && text === "‚úÖ Confirmar y guardar datos") {
    const sheet = sheets.find(s => s.getName() === state.hojaEncontrada);
    const lastRow = sheet.getLastRow();
    const nombres = sheet.getRange(`A2:A${lastRow}`).getValues().flat();

    for (let i = 0; i < nombres.length; i++) {
      if (nombres[i].toString().toLowerCase().trim() === state.nombreCompleto.toLowerCase().trim()) {
        const row = i + 2;
        sheet.getRange(row, state.hojaEncontrada === "INSTITUTO DE A√ëO" ? 4 : 5).setValue(state.fotoMes); // D o E seg√∫n hoja
        sheet.getRange(row, state.hojaEncontrada === "INSTITUTO DE A√ëO" ? 5 : 6).setValue(Utilities.formatDate(new Date(), "GMT-3", "dd/MM/yyyy HH:mm:ss"));
        sheet.getRange(row, state.hojaEncontrada === "INSTITUTO DE A√ëO" ? 6 : 7).setValue(userName);
        break;
      }
    }

    clearState(chatId);
    sendMessage(chatId, "‚úÖ Comprobante de pago cargado con √©xito", mainKeyboard());
    return;
  }
}

// ==================================================
// MAILS AUTOM√ÅTICOS POR MINISTERIO (TRIGGER)
// ==================================================
function enviarMailsPendientes() {
  const sheets = SpreadsheetApp.openById(SPREADSHEET_ID).getSheets();

  sheets.forEach(sheet => {
    const sheetName = sheet.getName();

    // Omitir hoja de peticiones
    if (sheetName === "PETICIONES") return;

    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return;

    // Datos: A-G + M-N
    const data = sheet.getRange(2, 1, lastRow - 1, 14).getValues();

    // Correos del ministerio (columna I)
    const emails = sheet
      .getRange(`I2:I${sheet.getLastRow()}`)
      .getValues()
      .flat()
      .filter(String);

    if (emails.length === 0) return;

    data.forEach((row, index) => {
      const [mentor, lider, foto, motivo, fechaHora, usuario, enviado, , , , , , asistentes, ofrenda] = row;

      // Si ya fue enviado, no repetir
      if (enviado === "SI") return;

      const cuerpoMail =
`Se registr√≥ una nueva espiga.

Ministerio: ${sheetName}
Mentor: ${mentor}
L√≠der: ${lider}
Usuario Telegram: ${usuario}
Fecha y hora: ${fechaHora}

Asistentes y persona nueva:
${asistentes || "No especificado"}

Ausencias y motivo de oraci√≥n:
${motivo}

Monto de ofrenda:
${ofrenda || "No especificado"}

Link del sobre (Google Drive):
${foto}
`;

      emails.forEach(mail => {
        MailApp.sendEmail(
          mail,
          `Nueva espiga cargada ‚Äì ${sheetName}`,
          cuerpoMail
        );
      });

      // Marcar como enviado (columna G)
      sheet.getRange(index + 2, 7).setValue("SI");
    });
  });
}

// ==================================================
// REPORTE SEMANAL GENERAL
// ==================================================
function enviarReporteSemanalGeneral() {
  const sheets = getMinisteriosSheets();
  const hoy = new Date();
  const desde = new Date(hoy.getTime() - 7 * 24 * 60 * 60 * 1000);

  let cuerpo = "Reporte semanal de ministerios\n\n";

  sheets.forEach(sheet => {
    const fechas = sheet.getRange(2, 5, sheet.getLastRow() - 1, 1).getValues();
    const cantidad = fechas.filter(f => f[0] instanceof Date && f[0] >= desde).length;
    cuerpo += `${sheet.getName()}: ${cantidad > 0 ? cantidad + " sobres cargados" : "no registr√≥ cargas"}\n`;
  });

  MailApp.sendEmail(
    EMAIL_REPORTE_GENERAL,
    "Reporte semanal de ministerios",
    cuerpo
  );
}